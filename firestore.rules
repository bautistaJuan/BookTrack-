rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isValidBookStatus(status) {
      return status in ['to read', 'reading', 'finished'];
    }
    
    function isValidBook(data) {
      return data.keys().hasAll(['title', 'author', 'pages', 'pagesRead', 'status'])
        && data.title is string
        && data.title.size() > 0
        && data.title.size() <= 200
        && data.author is string
        && data.author.size() > 0
        && data.author.size() <= 100
        && data.pages is int
        && data.pages > 0
        && data.pages <= 10000
        && data.pagesRead is int
        && data.pagesRead >= 0
        && data.pagesRead <= data.pages
        && isValidBookStatus(data.status);
    }
    
    function isValidBookUpdate(data) {
      // Allow partial updates
      return (!('title' in data) || (data.title is string && data.title.size() > 0 && data.title.size() <= 200))
        && (!('author' in data) || (data.author is string && data.author.size() > 0 && data.author.size() <= 100))
        && (!('pages' in data) || (data.pages is int && data.pages > 0 && data.pages <= 10000))
        && (!('pagesRead' in data) || (data.pagesRead is int && data.pagesRead >= 0))
        && (!('status' in data) || isValidBookStatus(data.status));
    }
    
    // Users collection
    match /users/{userId} {
      // Users can only read/write their own user document
      allow read, write: if isOwner(userId);
      
      // Books subcollection
      match /books/{bookId} {
        // Only the owner can read their books
        allow read: if isOwner(userId);
        
        // Only the owner can create books with valid data
        allow create: if isOwner(userId) 
          && isValidBook(request.resource.data)
          && request.resource.data.userId == request.auth.uid;
        
        // Only the owner can update their books with valid data
        allow update: if isOwner(userId) 
          && isValidBookUpdate(request.resource.data);
        
        // Only the owner can delete their books
        allow delete: if isOwner(userId);
      }
    }
    
    // Deny all other access by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
